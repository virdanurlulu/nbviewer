<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Header Calculation Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    fieldset { margin-bottom: 20px; padding: 15px; }
    legend { font-weight: bold; }
    label { display: inline-block; width: 180px; margin-top: 8px; }
    input, select { width: 200px; padding: 4px; margin-top: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table th, table td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    button { margin-top: 10px; padding: 8px 12px; }
    #exportBtn { background: #28a745; color: #fff; border: none; cursor: pointer; }
    /* sementara tampilkan sheet data agar bisa debug, nanti bisa di-hide kembali */
    #sheetPipeData { margin-top: 30px; }
  </style>
</head>
<body>

  <h1>Header Calculation Form</h1>

  <form id="headerForm">
    <fieldset>
      <legend>1. Input Data (Inlets)</legend>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Flowrate (L/h)</th>
            <th>Pipe Size (NPS)</th>
            <th>ID (mm)</th>
            <th>Velocity (m/s)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="inletsTbody"></tbody>
      </table>
      <button type="button" id="addInlet">Add Inlet</button>
    </fieldset>

    <fieldset>
      <legend>2. Header Design</legend>
      <label for="headerSize">Header Pipe Size (NPS)</label>
      <input list="npsList" id="headerSize" required />
      <datalist id="npsList"></datalist>

      <label for="headerID">Header ID (mm)</label>
      <input type="number" id="headerID" readonly />

      <label for="pipeMaterial">Pipe Material</label>
      <input type="text" id="pipeMaterial" readonly />

      <label for="pipeDensity">Pipe Density (kg/m³)</label>
      <input type="number" id="pipeDensity" readonly />

      <label for="roughness">Pipe Roughness (m)</label>
      <input type="number" id="roughness" readonly />

      <label for="headerLength">Header Length (m)</label>
      <input type="number" id="headerLength" value="20" min="0" required />

      <label for="fluidDensity">Fluid Density (kg/m³)</label>
      <input type="number" id="fluidDensity" value="1000" min="0" step="any" required />

      <label for="fluidViscosity">Fluid Viscosity (Pa·s)</label>
      <input type="number" id="fluidViscosity" value="0.001" min="0" step="any" required />
    </fieldset>

    <button type="submit">Calculate</button>
  </form>

  <div id="results"></div>
  <button id="exportBtn" style="display:none;">Export Results to Excel</button>

  <!-- sheetPipeData hanya untuk reference dan debug, bisa kalian hide -->
  <fieldset id="sheetPipeData">
    <legend>Sheet: Pipe Data (debug only)</legend>
    <table>
      <thead>
        <tr>
          <th>NPS</th><th>OD</th><th>thk</th><th>ID</th><th>Mat</th><th>ρ</th><th>ε (mm)</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>0.5"</td> <td>21.3</td>  <td>2.11</td> <td>17.08</td> <td>SS</td>  <td>8000</td> <td>0.06</td></tr>
        <tr><td>0.75"</td><td>26.7</td>  <td>2.11</td> <td>22.48</td> <td>SS</td>  <td>8000</td> <td>0.06</td></tr>
        <tr><td>1"</td>   <td>33.4</td>  <td>2.77</td> <td>27.86</td> <td>CS</td>  <td>7850</td> <td>0.046</td></tr>
        <tr><td>1.5"</td> <td>48.3</td>  <td>2.77</td> <td>42.76</td> <td>GS</td>  <td>7850</td> <td>0.15</td></tr>
        <tr><td>2"</td>   <td>60.3</td>  <td>2.77</td> <td>54.76</td> <td>CS</td>  <td>7850</td> <td>0.046</td></tr>
        <tr><td>2.5"</td> <td>73.0</td>  <td>3.05</td> <td>66.90</td> <td>CS</td>  <td>7850</td> <td>0.046</td></tr>
        <tr><td>3"</td>   <td>88.9</td>  <td>3.05</td> <td>82.80</td> <td>CS</td>  <td>7850</td> <td>0.046</td></tr>
        <tr><td>4"</td>   <td>114.3</td> <td>3.05</td> <td>108.20</td><td>CS</td>  <td>7850</td> <td>0.046</td></tr>
        <tr><td>5"</td>   <td>141.3</td> <td>3.40</td> <td>134.50</td><td>CS</td>  <td>7850</td> <td>0.046</td></tr>
        <tr><td>6"</td>   <td>168.3</td> <td>3.40</td> <td>161.50</td><td>CS</td>  <td>7850</td> <td>0.046</td></tr>
        <tr><td>8"</td>   <td>219.1</td> <td>3.76</td> <td>211.58</td><td>CS</td>  <td>7850</td> <td>0.046</td></tr>
      </tbody>
    </table>
  </fieldset>

  <!-- 1) load SheetJS tanpa defer -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    (function(){
      console.log('Initializing Header Calc…');

      // 2) parse sheet-table → pipeData
      const pipeData = [];
      document.querySelectorAll('#sheetPipeData tbody tr').forEach(tr => {
        const [nps, od, th, id, mat, dens, eps] =
          Array.from(tr.children).map(td => td.textContent.trim());
        pipeData.push({
          nps,
          od:         parseFloat(od),
          thickness:  parseFloat(th),
          id:         parseFloat(id),
          material:   mat,
          density:    parseFloat(dens),
          roughness:  parseFloat(eps) / 1000,
          area:       0
        });
      });
      if(pipeData.length===0) {
        console.error('pipeData kosong! Cek tabel sheetPipeData');
        return;
      }
      pipeData.forEach(p => {
        p.area = Math.PI * Math.pow((p.id/1000)/2, 2);
      });

      // 3) isi datalist NPS
      const dl = document.getElementById('npsList');
      pipeData.forEach(p => {
        const o = document.createElement('option');
        o.value = p.nps;
        dl.appendChild(o);
      });

      // 4) inlet rows
      let cnt = 0;
      const tbody = document.getElementById('inletsTbody');
      function addRow(){
        cnt++;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cnt}</td>
          <td><input class="flow" type="number" min="0" step="any" required></td>
          <td>
            <select class="inletSize" required>
              <option value="">--Select--</option>
              ${pipeData.map(p=>`<option value="${p.nps}">${p.nps}</option>`).join('')}
            </select>
          </td>
          <td><input class="inletID" readonly></td>
          <td><input class="inletVel" readonly></td>
          <td><button type="button" class="rm">✖</button></td>`;
        tbody.appendChild(tr);
        tr.querySelector('.rm').onclick = ()=> tr.remove();
        tr.querySelector('.flow').oninput = ()=> calcInlet(tr);
        tr.querySelector('.inletSize').onchange = ()=> calcInlet(tr);
      }
      document.getElementById('addInlet').onclick = addRow;
      for(let i=0;i<8;i++) addRow();

      function calcInlet(tr){
        const q = +tr.querySelector('.flow').value||0;
        const size = tr.querySelector('.inletSize').value;
        const pd = pipeData.find(p=>p.nps===size);
        if(!pd) return;
        tr.querySelector('.inletID').value = pd.id;
        const v = q/1000/3600/pd.area;
        tr.querySelector('.inletVel').value = v.toFixed(3);
      }

      // 5) headerSize pick
      document.getElementById('headerSize').oninput = function(){
        const pd = pipeData.find(p=>p.nps===this.value);
        if(!pd) return;
        document.getElementById('headerID').value     = pd.id;
        document.getElementById('pipeMaterial').value = pd.material;
        document.getElementById('pipeDensity').value  = pd.density;
        document.getElementById('roughness').value    = pd.roughness;
      };

      // 6) submit → calculate
      document.getElementById('headerForm').onsubmit = function(e){
        e.preventDefault();
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const flows=[], ids=[];
        rows.forEach(r=>{
          const f=+r.querySelector('.flow').value;
          const i=+r.querySelector('.inletID').value;
          if(f>0&&i>0){ flows.push(f); ids.push(i); }
        });
        if(flows.length===0){
          alert('Isi minimal 1 inlet');
          return;
        }

        const totalQ = flows.reduce((a,b)=>a+b,0);
        const maxID  = Math.max(...ids);
        const D_mm   = +document.getElementById('headerID').value;
        const D_m    = D_mm/1000;
        const L      = +document.getElementById('headerLength').value;
        const e      = +document.getElementById('roughness').value;
        const rho    = +document.getElementById('fluidDensity').value;
        const mu     = +document.getElementById('fluidViscosity').value;
        const g = 9.81;

        const Qm3 = totalQ/1000/3600;
        const area= Math.PI*(D_m/2)**2;
        const v   = Qm3/area;
        const Re  = v*D_m*rho/mu;
        const fct = 0.25/Math.pow(Math.log10(e/(3.7*D_m)+5.74/Math.pow(Re,0.9)),2);
        const hf  = fct*(L/D_m)*v**2/(2*g);
        const dp  = hf*rho*g/1e5;

        const c1 = D_mm>1.33*maxID;
        const c2 = v<=2;
        const c3 = dp<1;
        const ok = [c1,c2,c3].filter(x=>x).length>=2;

        document.getElementById('results').innerHTML = `
          <fieldset><legend>3. Results</legend>
          <table>
            <tr><th>Param</th><th>Value</th></tr>
            <tr><td>Total Q</td><td>${totalQ.toFixed(2)}</td></tr>
            <tr><td>v</td><td>${v.toFixed(3)}</td></tr>
            <tr><td>Re</td><td>${Re.toFixed(0)}</td></tr>
            <tr><td>f</td><td>${fct.toFixed(5)}</td></tr>
            <tr><td>hf</td><td>${hf.toFixed(3)}</td></tr>
            <tr><td>ΔP (bar)</td><td>${dp.toFixed(4)}</td></tr>
            <tr><td>OK?</td>
              <td style="color:${ok?'green':'red'}">
                ${ok?'YES':'NO'} (S:${c1},V:${c2},P:${c3})
              </td></tr>
          </table>
          </fieldset>`;
        document.getElementById('exportBtn').style.display='inline-block';
      };

      // 7) export
      document.getElementById('exportBtn').onclick = function(){
        const trs = Array.from(document.querySelectorAll('#results table tr')).slice(1);
        const arr = trs.map(r=>({
          Param: r.cells[0].textContent,
          Value: r.cells[1].textContent
        }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(arr);
        XLSX.utils.book_append_sheet(wb, ws, 'Results');
        XLSX.writeFile(wb, 'HeaderCalc.xlsx');
      };

      console.log('Header Calc initialized.');
    })();
  </script>
</body>
</html>
